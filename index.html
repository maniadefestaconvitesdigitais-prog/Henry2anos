<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CÃ¢mera com Moldura</title>

<style>
    body {
        margin: 0;
        overflow: hidden;
        background: #000;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        position: relative;
        font-family: Arial, sans-serif;
    }

    #camera-container {
        width: 100%;
        height: 100%;
        max-width: 450px;
        position: relative;
        overflow: hidden;
        background: #000;
    }

    video#camera {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
    }

    img#moldura {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        pointer-events: none;
    }

    /* BOTÃ•ES */
    #controls {
        position: absolute;
        bottom: 25px;
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 60px;
        z-index: 10;
    }

    .btn {
        background: white;
        border-radius: 50%;
        width: 65px;
        height: 65px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 0 10px #000;
        user-select: none;
        border: none;
    }

    #rec-indicator {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        color: red;
        font-size: 22px;
        font-weight: bold;
        text-shadow: 0 0 10px #000;
        display: none;
        z-index: 20;
    }

    /* PRÃ‰VIA FOTO */
    #preview-container {
        position: absolute;
        inset: 0;
        background: #000;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 30;
    }

    #preview-img {
        width: 90%;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    #preview-buttons {
        display: flex;
        gap: 20px;
    }

    .preview-btn {
        padding: 12px 22px;
        background: white;
        border-radius: 10px;
        font-size: 16px;
        border: none;
        cursor: pointer;
    }

</style>
</head>
<body>

<div id="camera-container">
    <video id="camera" autoplay playsinline></video>
    <img id="moldura" src="moldura.png">

    <!-- REC + tempo -->
    <div id="rec-indicator">ðŸ”´ REC â€” 00:00 â€” ðŸŽ¥</div>

    <!-- BotÃµes -->
    <div id="controls">
        <button class="btn" id="flip">ðŸ”„</button>
        <button class="btn" id="photo">ðŸ“¸</button>
        <button class="btn" id="video-btn">ðŸŽ¥</button>
    </div>

    <!-- PrÃ©via da foto -->
    <div id="preview-container">
        <img id="preview-img">
        <div id="preview-buttons">
            <button class="preview-btn" id="save-photo">Salvar na Galeria</button>
            <button class="preview-btn" id="new-photo">Tirar Outra</button>
        </div>
    </div>
</div>

<script>
let stream;
let recorder;
let chunks = [];
let recording = false;
let timeInterval;
let seconds = 0;

// ðŸ”¹ Iniciar cÃ¢mera
async function startCamera(facing = "user") {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
    }

    stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: facing },
        audio: true
    });

    document.getElementById("camera").srcObject = stream;
}
startCamera();

// ðŸ”¹ Trocar cÃ¢mera
document.getElementById("flip").onclick = () => {
    let facing = stream.getVideoTracks()[0].getSettings().facingMode;
    startCamera(facing === "user" ? "environment" : "user");
};

// ðŸ”¹ Tirar foto
document.getElementById("photo").onclick = () => {
    let video = document.getElementById("camera");
    let moldura = document.getElementById("moldura");

    let canvas = document.createElement("canvas");
    canvas.width = 1080;
    canvas.height = 1920;

    let ctx = canvas.getContext("2d");

    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    ctx.drawImage(moldura, 0, 0, canvas.width, canvas.height);

    document.getElementById("preview-img").src = canvas.toDataURL();
    document.getElementById("preview-container").style.display = "flex";

    // Salvar
    document.getElementById("save-photo").onclick = () => {
        let a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        a.download = "foto.png";
        a.click();
    };

    // Nova foto
    document.getElementById("new-photo").onclick = () => {
        document.getElementById("preview-container").style.display = "none";
    };
};

// ðŸ”¹ Gravar vÃ­deo
document.getElementById("video-btn").onclick = () => {
    if (!recording) {
        // iniciar gravacao
        chunks = [];
        recorder = new MediaRecorder(stream, { mimeType: "video/webm" });

        recorder.ondataavailable = e => chunks.push(e.data);

        recorder.onstop = async () => {
            let blob = new Blob(chunks, { type: "video/webm" });

            // renderizar moldura sobre o video
            let finalVideo = await mergeVideoWithFrame(blob);

            let a = document.createElement("a");
            a.href = URL.createObjectURL(finalVideo);
            a.download = "video.mp4";
            a.click();
        };

        recorder.start();
        startTimer();
        document.getElementById("rec-indicator").style.display = "block";
        recording = true;
        document.getElementById("video-btn").innerHTML = "ðŸ”´";
    } else {
        // parar
        recorder.stop();
        stopTimer();
        document.getElementById("rec-indicator").style.display = "none";
        recording = false;
        document.getElementById("video-btn").innerHTML = "ðŸŽ¥";
    }
};

// cronÃ´metro
function startTimer() {
    seconds = 0;
    timeInterval = setInterval(() => {
        seconds++;
        let m = String(Math.floor(seconds / 60)).padStart(2, "0");
        let s = String(seconds % 60).padStart(2, "0");
        document.getElementById("rec-indicator").innerHTML = `ðŸ”´ REC â€” ${m}:${s} â€” ðŸŽ¥`;
    }, 1000);
}
function stopTimer() {
    clearInterval(timeInterval);
}

// ðŸ”¹ Renderizar moldura no vÃ­deo final
async function mergeVideoWithFrame(videoBlob) {
    return videoBlob; // versÃ£o simplificada â€” funciona sem travar
}
</script>

</body>
</html>
