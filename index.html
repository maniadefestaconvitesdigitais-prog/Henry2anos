<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Henrique 2 Anos - Moldura</title>
<style>
  :root{--btn-size:70px}
  html,body{height:100%;margin:0;background:#000;overflow:hidden;font-family:Arial,Helvetica,sans-serif}
  #cameraWrap{position:fixed;inset:0;display:flex;justify-content:center;align-items:center;background:#000}
  video#cam{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:none;z-index:1}
  img#overlay{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;pointer-events:none;z-index:2}

  /* CONTROLS */
  .controls{position:fixed;left:0;right:0;bottom:env(safe-area-inset-bottom,20px);display:flex;justify-content:space-around;align-items:center;z-index:4;padding:8px 16px}
  .btn{width:var(--btn-size);height:var(--btn-size);border-radius:50%;background:#fff;border:none;display:flex;align-items:center;justify-content:center;font-size:28px;box-shadow:0 6px 18px rgba(0,0,0,.3);cursor:pointer}
  .btn.recording{background:#fff;color:#d00}
  .small{width:50px;height:50px;border-radius:50%;font-size:20px}

  /* REC indicator (top center) */
  #recBar{position:fixed;top:env(safe-area-inset-top,8px);left:50%;transform:translateX(-50%);display:flex;gap:8px;align-items:center;background:rgba(0,0,0,0.35);padding:6px 12px;border-radius:20px;color:#fff;font-weight:600;z-index:5;visibility:hidden}
  .dot{width:12px;height:12px;border-radius:50%;background:#d00;box-shadow:0 0 8px rgba(208,0,0,.9)}

  /* Photo preview overlay */
  #previewLayer{position:fixed;inset:0;display:none;z-index:10;align-items:center;justify-content:center;background:rgba(0,0,0,0.75);flex-direction:column;padding:18px;gap:12px}
  #previewImg{max-width:94%;max-height:72vh;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.6)}
  .previewBtns{display:flex;gap:12px;margin-top:12px}
  .actionBtn{padding:12px 18px;border-radius:10px;background:#fff;border:none;font-weight:700;cursor:pointer}

  /* mini-video thumbnail (quando vÃ­deo gravado) */
  #miniThumb{position:fixed;bottom:120px;left:12px;width:96px;height:170px;border-radius:8px;overflow:hidden;display:none;z-index:6;background:#000}
  #miniThumb video{width:100%;height:100%;object-fit:cover}
</style>
</head>
<body>

<div id="cameraWrap">
  <video id="cam" autoplay playsinline muted></video>
  <img id="overlay" src="moldura.png" alt="moldura">
</div>

<!-- REC + timer -->
<div id="recBar"><div class="dot"></div><div id="recText">REC 00:00</div></div>

<!-- mini thumb do vÃ­deo gravado (opcional) -->
<div id="miniThumb"><video id="miniVideo" muted loop></video></div>

<!-- photo preview -->
<div id="previewLayer">
  <img id="previewImg" alt="prÃ©via foto">
  <div class="previewBtns">
    <button id="savePhoto" class="actionBtn">SALVAR NA GALERIA</button>
    <button id="retake" class="actionBtn">TIRAR OUTRA</button>
  </div>
</div>

<!-- controles -->
<div class="controls">
  <button id="flip" class="btn small" title="Virar cÃ¢mera">ðŸ”„</button>
  <button id="photoBtn" class="btn" title="Tirar foto">ðŸ“¸</button>
  <button id="recordBtn" class="btn" title="Gravar vÃ­deo">ðŸŽ¥</button>
</div>

<!-- canvas fixo 9:16 para garantir exportaÃ§Ã£o em 1080x1920 -->
<canvas id="recCanvas" width="1080" height="1920" style="display:none"></canvas>

<script>
/* === configuraÃ§Ãµes iniciais === */
const overlayName = "moldura.png"; // certifique-se que este Ã© o nome no repo
const cam = document.getElementById('cam');
const overlay = document.getElementById('overlay');
const recCanvas = document.getElementById('recCanvas');
const recCtx = recCanvas.getContext('2d');

const flipBtn = document.getElementById('flip');
const photoBtn = document.getElementById('photoBtn');
const recordBtn = document.getElementById('recordBtn');

const previewLayer = document.getElementById('previewLayer');
const previewImg = document.getElementById('previewImg');
const savePhoto = document.getElementById('savePhoto');
const retake = document.getElementById('retake');

const recBar = document.getElementById('recBar');
const recText = document.getElementById('recText');

const miniThumb = document.getElementById('miniThumb');
const miniVideo = document.getElementById('miniVideo');

/* estado */
let stream = null;
let usingFront = true;
let mediaRecorder = null;
let recStream = null;
let recChunks = [];
let recRafId = null;
let recStartTime = null;
let recTimerInterval = null;

/* forza o overlay a carregar (garante cache) */
overlay.src = overlayName;

/* === iniciar cÃ¢mera === */
async function startCamera(){
  if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingFront ? 'user' : 'environment' }, audio: true });
    cam.srcObject = stream;
  } catch(e){
    alert("Permita o acesso Ã  cÃ¢mera e microfone no navegador.");
    console.error(e);
  }
}
startCamera();

/* === util: desenhar camera com cover dentro do canvas 1080x1920 === */
function drawToCanvas(targetCtx, targetW = 1080, targetH = 1920){
  // pega dimensÃµes do vÃ­deo ao vivo
  const vw = cam.videoWidth || 1280;
  const vh = cam.videoHeight || 720;
  if (!vw || !vh) return;

  // calcular scale-cover
  const scale = Math.max(targetW / vw, targetH / vh);
  const sw = vw * scale;
  const sh = vh * scale;
  const sx = (targetW - sw) / 2;
  const sy = (targetH - sh) / 2;

  // desenha vÃ­deo (cover)
  targetCtx.clearRect(0,0,targetW,targetH);
  try {
    targetCtx.drawImage(cam, 0, 0, vw, vh, sx, sy, sw, sh);
  } catch(e) { /* pode falhar enquanto o vÃ­deo nÃ£o estÃ¡ pronto */ }

  // desenha moldura por cima (estica para preencher)
  try {
    targetCtx.drawImage(overlay, 0, 0, targetW, targetH);
  } catch(e){}
}

/* === FOTO: captura + prÃ©via === */
photoBtn.addEventListener('click', () => {
  // desenha frame atual no canvas 1080x1920
  drawToCanvas(recCtx, 1080, 1920);

  // gerar dataURL e mostrar prÃ©via
  const dataUrl = recCanvas.toDataURL('image/png');
  previewImg.src = dataUrl;
  previewLayer.style.display = 'flex';

  // definir aÃ§Ã£o salvar (download)
  savePhoto.onclick = () => {
    downloadDataUrl(dataUrl, `henrique_foto_${Date.now()}.png`);
  };

  // tirar outra
  retake.onclick = () => {
    previewLayer.style.display = 'none';
    previewImg.src = '';
  };
});

/* === gravaÃ§Ã£o: desenhar frames numa canvas e gravar dela (com Ã¡udio) === */
recordBtn.addEventListener('click', async () => {
  if (!mediaRecorder || mediaRecorder.state === 'inactive') {
    // iniciar gravaÃ§Ã£o
    recChunks = [];

    // cria stream do canvas
    recStream = recCanvas.captureStream(30); // 30 fps
    // anexar Ã¡udio do stream original (se houver)
    try {
      const audioTracks = stream.getAudioTracks();
      if (audioTracks && audioTracks.length) audioTracks.forEach(t => recStream.addTrack(t));
    } catch(e){ console.warn('nÃ£o foi possÃ­vel anexar audio:', e); }

    // preparar MediaRecorder
    try {
      mediaRecorder = new MediaRecorder(recStream, { mimeType: 'video/webm;codecs=vp8,opus' });
    } catch(err) {
      alert('GravaÃ§Ã£o nÃ£o suportada no seu navegador. Use Chrome no Android para melhor compatibilidade.');
      console.error(err);
      return;
    }

    mediaRecorder.ondataavailable = e => { if (e.data && e.data.size) recChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      const blob = new Blob(recChunks, { type: 'video/webm' });
      // baixar automaticamente
      const url = URL.createObjectURL(blob);
      downloadUrl(url, `henrique_video_${Date.now()}.webm`);
      // mini thumbnail (opcional) - mostramos mini thumb sem prÃ©via completa
      miniVideo.src = url;
      miniThumb.style.display = 'block';
      setTimeout(()=> URL.revokeObjectURL(url), 2000);
    };

    // comeÃ§ar loop de desenho
    function drawLoop(){
      drawToCanvas(recCtx, 1080, 1920);
      recRafId = requestAnimationFrame(drawLoop);
    }
    drawLoop();

    // iniciar gravaÃ§Ã£o
    mediaRecorder.start();
    recordBtn.classList.add('recording');
    recordBtn.textContent = 'ðŸ”´';
    showRecBar(true);
    recStartTime = Date.now();
    recTimerInterval = setInterval(updateRecTimer, 250);
  } else {
    // parar gravaÃ§Ã£o
    mediaRecorder.stop();
    if (recRafId) cancelAnimationFrame(recRafId);
    recordBtn.classList.remove('recording');
    recordBtn.textContent = 'ðŸŽ¥';
    showRecBar(false);
    clearInterval(recTimerInterval);
    recTimerInterval = null;
  }
});

/* === helpers: show/hide rec bar and update timer === */
function showRecBar(on){
  recBar.style.visibility = on ? 'visible' : 'hidden';
  if (!on) recText.textContent = 'REC 00:00';
}
function updateRecTimer(){
  if (!recStartTime) return;
  const diff = Math.floor((Date.now() - recStartTime)/1000);
  const mm = String(Math.floor(diff/60)).padStart(2,'0');
  const ss = String(diff%60).padStart(2,'0');
  recText.textContent = `REC ${mm}:${ss}`;
}

/* === util: download helpers === */
function downloadDataUrl(dataUrl, filename){
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function downloadUrl(url, filename){
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}

/* === flip camera === */
flipBtn.addEventListener('click', () => {
  usingFront = !usingFront;
  startCamera();
});

/* === ocultar miniThumb ao tocar === */
miniThumb.addEventListener('click', () => {
  // abrir em nova aba para visualizar melhor
  if (miniVideo.src) window.open(miniVideo.src, '_blank');
});
</script>
</body>
</html>
